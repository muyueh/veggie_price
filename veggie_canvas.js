// Generated by LiveScript 1.2.0
var ref$, drop, each, take, map, keys, listsToObj, parseDate, shNaN, typShNaN, view, lsmkt, lssbtype, lstyphon, lscolor, lsveggie, enname, lsenname, datechage, datebetween;
ref$ = require("prelude-ls"), drop = ref$.drop, each = ref$.each, take = ref$.take, map = ref$.map, keys = ref$.keys, listsToObj = ref$.listsToObj;
parseDate = function(string){
  var y, m, d;
  y = string.split("年")[0];
  m = string.split("年")[1].split("月")[0];
  d = string.split("月")[1].split("日")[0];
  return new Date(((+y) + 1911) + " " + m + " " + d);
};
shNaN = {
  "date": true,
  "mktname": true,
  "sbtype": true,
  "transformation": true,
  "middleprice": false,
  "quantity": false
};
typShNaN = {
  "alertDate": true,
  "force7km": null,
  "force10km": null,
  "id": false,
  "level": true,
  "maxMS": false,
  "minhPa": false,
  "name": true,
  "nameEn": true,
  "numAlert": false,
  "path": null,
  "year": false
};
view = "middleprice";
lsmkt = {};
lssbtype = {};
lstyphon = {};
lscolor = {};
lsveggie = ["LI萵苣菜", "FY玉米", "LA甘藍", "SG大蒜", "LC包心白", "FG苦瓜", "SE青蔥", "LG芹菜", "FV辣椒", "FL豌豆", "FN敏豆", "FK甜椒", "FI茄子", "FH扁蒲", "FF絲瓜", "FJ番茄", "LJ芥菜", "LB小白菜", "SP薑", "SA蘿蔔", "FT南瓜", "FB花椰菜", "SJ芋", "SX芽菜類", "FM菜豆", "FC胡瓜", "SB胡蘿蔔", "FD花胡瓜", "SO甘薯", "FE冬瓜", "LF蕹菜", "LK芥藍菜", "SV蘆筍", "LM莧菜", "FR青花苔", "SF韭菜", "SU薯蕷", "LH菠菱菜", "SD洋蔥", "OX其他", "SQ茭白筍", "LD青江白菜", "SC馬鈴薯", "SF3韭菜(韭菜花)", "LX蕨菜", "SW球莖甘藍", "FU準人瓜", "LN油菜", "FP萊豆", "SH1竹筍(麻竹筍)", "OA鹹菜", "LL茼蒿", "LE皇宮菜", "SM牛蒡", "FZ落花生", "SN蓮藕", "LP2九層塔", "SS大心菜", "OH桶筍", "SF2韭菜(韭菜黃)", "FQ毛豆", "LO甘薯葉", "LP芫荽", "LQ紅鳳菜", "LT海菜", "FA1黃秋葵", "SL1豆薯", "MA洋菇", "ME金絲菇", "OE醃瓜", "LZ薺菜", "SH2竹筍(綠竹筍)", "MC木耳", "SH5竹筍(烏殼綠)", "MD香菇", "SR菱角", "MI秀珍菇", "MJ杏鮑菇", "MF蠔菇", "MB草菇", "SI萵苣莖", "SK荸薺", "LS茴香", "OG熟筍", "FS越瓜", "LV巴西利", "OB雪里紅", "OD蘿蔔乾", "MX其他菇類", "MK鴻禧菇", "SH4竹筍(孟宗筍)", "FU3石蓮花", "ML珊瑚菇", "FW金針花", "OC榨菜", "FX2虎豆(福豆)", "SZ3金針筍", "OI4筍茸", "MN柳松菇", "SH7竹筍(去殼)", "OI3筍片", "OI1筍乾", "OI2筍絲", "LU菾菜", "LY1西洋菜", "SZ1半天筍", "FX1花豆", "SZ4百合", "OL朴菜", "ST蕎頭", "SH3竹筍(桂竹筍)", "MH松茸", "LY2黑甜仔菜", "MG白菇", "SH6竹筍(箭竹筍)", "FA0其他花類", "MM猴頭菇", "FW2洛神花", "SZ5草石蠶", "LY5珍珠菜", "LT3水蓮", "LY6香椿", "SZ6半天花", "FA9百果(進口)", "FO蠶豆", "LY3豬母菜", "LY4人參葉", "SZ2甘蔗筍", "LR塌棵塔", "FA2樊花", "SY慈菇", "SL2菊芋(雪蓮薯)", "FA4瓊花", "SH9竹筍(進口)", "ZZ其他"];
enname = ["Lettuce", "Corn", "Cabbage", "Garlic", "White Heart Bag", "Bitter", "Scallion", "Celery", "Chili", "Peas", "Min beans", "Sweet pepper", "Eggplant", "Flat Po", "Loofah", "Tomatoes", "Mustard", "Cabbage", "Ginger", "Radish", "Pumpkin", "Cauliflower", "Taro", "Sprouts class", "Kidney bean", "Cucumber", "Carrot", "Flowers cucumber", "Sweet", "Melon", "Ipomoea", "Kale", "Asparagus", "Amaranth", "Blue moss", "Chives", "Yam", "Bo Ling dish", "Onion", "Other", "Coba", "Bok cabbage", "Potato", "Leek ( chives )", "Bracken", "Kohlrabi", "Quasi- human melon", "Cole", "Lima bean", "Bamboo ( bamboo shoot )", "Pickle", "Chrysanthemum", "Palace dish", "Burdock", "Groundnut", "Lotus", "Basil", "Big cabbage", "Barrel shoots", "Leek ( leek yellow )", "Edamame", "Sweet potato leaves", "Coriander", "Gynura", "Seaweed", "Okra", "Yam bean", "Mushroom", "Watkins mushrooms", "Pickled melon", "Shepherd's purse", "Shoots ( green shoots )", "Fungus", "Bamboo shoots ( black shell Green )", "Mushrooms", "Water chestnut", "Oyster mushrooms", "Mushroom", "Oyster mushrooms", "Straw mushroom", "Stem lettuce", "Water chestnuts", "Fennel", "Cooked bamboo shoots", "Pickling melon", "Basili", "Potherb mustard", "Radish", "Other mushrooms", "Hongxi mushrooms", "Bamboo shoots ( Meng Zong shoots )", "Stone Lotus", "Coral mushroom", "Daylily", "Mustard", "Tiger beans ( beans Fu )", "Lily shoots", "Velvet shoots", "Liu pine mushrooms", "Bamboo shoots ( shelled )", "Sunpian", "Bamboo shoots", "Sunsi", "Chard", "Watercress", "Half-day shoot", "Bean flowers", "Lily", "Pak dish", "Shallots", "Bamboo ( bamboo shoots )", "Matsutake", "Aberdeen black sweet dish", "White mushrooms", "Bamboo ( bamboo shoots )", "Other flowers", "Hericium", "Roselle", "Chinese artichoke", "Lysimachia", "Shuilian", "Toon", "Spend half a day", "Mince ( import )", "Broad bean", "Sow vegetables", "Ginseng leaf", "Bamboo cane", "Narinosa tower", "Fan Flower", "Arrowhead", "Jerusalem artichoke ( lotus potato )", "Viburnum", "Bamboo shoots ( import )", "Other"];
lsenname = listsToObj(lsveggie, enname);
datechage = function(date, inc){
  var d;
  d = new Date(date);
  return new Date(d.setDate(d.getDate() + inc));
};
datebetween = function(start, end){
  var result, itrdate;
  result = [];
  itrdate = new Date(start);
  while (end - itrdate > 0) {
    result.push(itrdate);
    itrdate = datechage(itrdate, 1);
  }
  result.push(itrdate);
  return result;
};
d3.tsv("./typhon.tsv", function(err, typhonData){
  var color, name, input;
  typhonData = typhonData.filter(function(it){
    var tp, alert;
    for (tp in it) {
      if (typShNaN[tp] !== null && isNaN(it[tp]) !== typShNaN[tp]) {
        return false;
      } else if (!typShNaN[tp]) {
        it[tp] = +it[tp];
      }
    }
    alert = it.alertDate.split("～");
    it.start = new Date(it.year, alert[0].split("/")[0], alert[0].split("/")[1]);
    it.end = new Date(it.year, alert[1].split("/")[0], alert[1].split("/")[1]);
    it.during = datebetween(it.start, it.end);
    it.waybefore = datebetween(datechage(it.start, -10), datechage(it.start, -5));
    it.before = datebetween(datechage(it.start, -5), it.start);
    it.after = datebetween(it.end, datechage(it.end, +5));
    it.waybefore.map(function(it){
      return lstyphon[it] = "-10";
    });
    it.before.map(function(it){
      return lstyphon[it] = "-5";
    });
    it.after.map(function(it){
      return lstyphon[it] = "+5";
    });
    it.during.map(function(it){
      return lstyphon[it] = "T";
    });
    return true;
  });
  color = d3.scale.category20();
  name = "FQ毛豆";
  if (window.location.hash) {
    input = window.location.hash.split("#")[1];
    lsveggie.map(function(d, i){
      if (d.indexOf(input) > -1) {
        return name = lsveggie[i];
      }
    });
  }
  return d3.tsv("./data/" + name + ".tsv", function(err, tsvData){
    var margin, w, h, scaleX, scaleQ, scaleY, line, fltrData, canvas, canvasWidth, canvasHeight, ctx, canvasData, buf8, drawPixel, clear, updateCanvas, weekDayTable, barPriYear, barPriMonth, barPriWeek, barPriMkt, barPriSb, barPriTyp, barQuanYear, barQuanMonth, barQuanWeek, barQuanMkt, barQyanSb, barQuanTyp, ndx, all, sml, yearDim, monthDim, weekdayDim, mktDim, sbDim, tyDim, averageAdd, averageRemove, averageInitial, averageQuanAdd, averageQuanRemove, averageQuanInitial, priceYear, priceMonth, priceWeekDay, priceMkt, priceSb, priceTy, quanYear, quanMonth, quanWeekDay, quanMkt, quanSb, quanTy, barWidth, barHeight, marginJson, colorBike, colorBike2, yearExt, bpy, bpm, bqy, updateGraph, setList;
    tsvData = tsvData.filter(function(it){
      var tp, typhon;
      for (tp in it) {
        if (isNaN(it[tp]) !== shNaN[tp]) {
          return false;
        } else if (!shNaN[tp]) {
          it[tp] = +it[tp];
        }
      }
      if (it.mktname === "台北一") {
        it.mktname = "北一";
      } else if (it.mktname === "台北二") {
        it.mktname = "北二";
      } else {
        it.mktname = take(2, it.mktname);
      }
      if (lsmkt[it.mktname] === undefined) {
        lsmkt[it.mktname] = true;
      }
      if (lssbtype[it.sbtype] === undefined) {
        lssbtype[it.sbtype] = true;
      }
      it.date = parseDate(it.date);
      typhon = lstyphon[it.date + ""];
      it.status = typhon !== undefined ? typhon : "na";
      return true;
    }).sort(function(a, b){
      return a.date - b.date;
    });
    console.log(tsvData);
    margin = {
      top: 10,
      left: 10,
      right: 20,
      bottom: 20
    };
    w = 1200 - margin.left - margin.right;
    h = 200 - margin.top - margin.bottom;
    scaleX = d3.time.scale().range([0, w]).domain(d3.extent(tsvData.map(function(it){
      return it.date;
    })));
    scaleQ = d3.scale.linear().domain(d3.extent(tsvData.map(function(it){
      return it.quantity;
    }))).range([0, w]);
    scaleY = d3.scale.linear().domain([0, 300]).range([h, 0]);
    line = d3.svg.line().x(function(it){
      return scaleX(it.date);
    }).y(function(it){
      return scaleY(it.middleprice);
    });
    fltrData = tsvData;
    d3.select("body").selectAll(".pvsq").append("canvas").attr({
      "width": w,
      "height": h,
      "id": "yearvsvalue"
    });
    canvas = document.getElementById("yearvsvalue");
    canvasWidth = canvas.width;
    canvasHeight = canvas.height;
    ctx = canvas.getContext("2d");
    canvasData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
    buf8 = new Uint8ClampedArray(new ArrayBuffer(canvasData.data.length));
    drawPixel = function(x, y, r, g, b, a){
      var index;
      index = (x + y * canvasWidth) * 4;
      canvasData.data[index + 0] = r;
      canvasData.data[index + 1] = g;
      canvasData.data[index + 2] = b;
      return canvasData.data[index + 3] = a;
    };
    clear = function(){
      return canvasData.data.set(buf8);
    };
    updateCanvas = function(){
      return ctx.putImageData(canvasData, 0, 0);
    };
    weekDayTable = ["Sun.", "Mon.", "Tue.", "Wed.", "Thu.", "Fri.", "Sat."];
    barPriYear = dc.barChart('.pricePerYear');
    barPriMonth = dc.barChart('.pricePerMonth');
    barPriWeek = dc.barChart('.pricePerWeekDay');
    barPriMkt = dc.barChart('.pricePerMkt');
    barPriSb = dc.barChart('.pricePerSb');
    barPriTyp = dc.barChart('.pricePerTyp');
    barQuanYear = dc.barChart('.quanPerYear');
    barQuanMonth = dc.barChart('.quanPerMonth');
    barQuanWeek = dc.barChart('.quanPerWeekDay');
    barQuanMkt = dc.barChart('.quanPerMkt');
    barQyanSb = dc.barChart('.quanPerSb');
    barQuanTyp = dc.barChart('.quanPerTyp');
    ndx = crossfilter(tsvData);
    all = ndx.groupAll();
    sml = {};
    yearDim = ndx.dimension(function(it){
      return it.date.getFullYear();
    });
    monthDim = ndx.dimension(function(it){
      return it.date.getMonth();
    });
    weekdayDim = ndx.dimension(function(it){
      return weekDayTable[it.date.getDay()];
    });
    mktDim = ndx.dimension(function(it){
      return it.mktname;
    });
    sbDim = ndx.dimension(function(it){
      return it.sbtype;
    });
    tyDim = ndx.dimension(function(it){
      return it.status;
    });
    averageAdd = function(p, v){
      ++p.count;
      p.sum += v.middleprice;
      p.average = p.count ? Math.floor(p.sum / p.count) : 0;
      return p;
    };
    averageRemove = function(p, v){
      --p.count;
      p.sum -= v.middleprice;
      p.average = p.count ? Math.floor(p.sum / p.count) : 0;
      return p;
    };
    averageInitial = function(){
      return {
        count: 0,
        sum: 0,
        average: 0
      };
    };
    averageQuanAdd = function(p, v){
      ++p.count;
      p.sum += v.quantity;
      p.average = p.count ? Math.floor(p.sum / p.count) : 0;
      return p;
    };
    averageQuanRemove = function(p, v){
      --p.count;
      p.sum -= v.quantity;
      p.average = p.count ? Math.floor(p.sum / p.count) : 0;
      return p;
    };
    averageQuanInitial = function(){
      return {
        count: 0,
        sum: 0,
        average: 0
      };
    };
    priceYear = yearDim.group().reduce(averageAdd, averageRemove, averageInitial);
    priceMonth = monthDim.group().reduce(averageAdd, averageRemove, averageInitial);
    priceWeekDay = weekdayDim.group().reduce(averageAdd, averageRemove, averageInitial);
    priceMkt = mktDim.group().reduce(averageAdd, averageRemove, averageInitial);
    priceSb = sbDim.group().reduce(averageAdd, averageRemove, averageInitial);
    priceTy = tyDim.group().reduce(averageAdd, averageRemove, averageInitial);
    quanYear = yearDim.group().reduce(averageQuanAdd, averageQuanRemove, averageQuanInitial);
    quanMonth = monthDim.group().reduce(averageQuanAdd, averageQuanRemove, averageQuanInitial);
    quanWeekDay = weekdayDim.group().reduce(averageQuanAdd, averageQuanRemove, averageQuanInitial);
    quanMkt = mktDim.group().reduce(averageQuanAdd, averageQuanRemove, averageQuanInitial);
    quanSb = sbDim.group().reduce(averageQuanAdd, averageQuanRemove, averageQuanInitial);
    quanTy = tyDim.group().reduce(averageQuanAdd, averageQuanRemove, averageQuanInitial);
    barWidth = 150;
    barHeight = 80;
    marginJson = {
      "top": 10,
      "right": 10,
      "left": 50,
      "bottom": 30
    };
    colorBike = d3.rgb("#1f77b4").brighter(1);
    colorBike2 = d3.rgb("#ff7f0e").brighter(1);
    yearExt = d3.extent(tsvData.map(function(it){
      return it.date.getFullYear();
    }));
    bpy = barPriYear.width(barWidth).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(45)"
      });
    }).dimension(yearDim).group(priceYear).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.linear().domain(yearExt)).elasticY(true).colors(function(){
      return colorBike;
    }).on("filtered", function(){
      return updateGraph();
    });
    bpy.yAxis().ticks(3);
    bpy.xAxis().ticks(3);
    bpm = barPriMonth.width(barWidth + 60).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(monthDim).group(priceMonth).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.linear().domain([0, 12])).elasticY(true).colors(function(){
      return colorBike;
    }).on("filtered", function(){
      return updateGraph();
    });
    bpm.yAxis().ticks(3);
    barPriWeek.width(barWidth).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(weekdayDim).group(priceWeekDay).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.ordinal().domain(weekDayTable)).xUnits(dc.units.ordinal).gap(4).elasticY(true).colors(colorBike).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    barPriMkt.width(keys(lsmkt).length * 25 + marginJson.left + marginJson.right).height(barHeight).margins(marginJson).renderlet(function(it){
      it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
      return it.selectAll("rect.bar").each(function(it){
        return d3.select(this).attr("style", "fill:" + color(it.x));
      });
    }).dimension(mktDim).group(priceMkt).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.ordinal().domain(keys(lsmkt))).xUnits(dc.units.ordinal).gap(10).elasticY(true).colors(colorBike).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    barPriSb.width(keys(lssbtype).length * 25 + marginJson.left + marginJson.right).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(sbDim).group(priceSb).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.ordinal().domain(keys(lssbtype))).xUnits(dc.units.ordinal).gap(15).elasticY(true).colors(colorBike).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    barPriTyp.width(barWidth).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(tyDim).group(priceTy).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.ordinal().domain(["na", "-10", "-5", "T", "+5"])).xUnits(dc.units.ordinal).gap(10).elasticY(true).colors(colorBike).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    bqy = barQuanYear.width(barWidth).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(yearDim).group(quanYear).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.linear().domain(yearExt)).elasticY(true).colors(function(){
      return colorBike2;
    }).on("filtered", function(){
      return updateGraph();
    });
    bqy.yAxis().ticks(3);
    bqy.xAxis().ticks(3);
    barQuanMonth.width(barWidth + 60).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(monthDim).valueAccessor(function(it){
      return it.value.average;
    }).group(quanMonth).x(d3.scale.linear().domain([0, 12])).elasticY(true).colors(function(){
      return colorBike2;
    }).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    barQuanWeek.width(barWidth).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(weekdayDim).valueAccessor(function(it){
      return it.value.average;
    }).group(quanWeekDay).x(d3.scale.ordinal().domain(weekDayTable)).xUnits(dc.units.ordinal).gap(4).elasticY(true).colors(colorBike2).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    barQuanMkt.width(keys(lsmkt).length * 25 + marginJson.left + marginJson.right).height(barHeight).margins(marginJson).renderlet(function(it){
      it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
      return it.selectAll("rect.bar").each(function(it){
        return d3.select(this).attr("style", "fill:" + color(it.x));
      });
    }).dimension(mktDim).valueAccessor(function(it){
      return it.value.average;
    }).group(quanMkt).x(d3.scale.ordinal().domain(keys(lsmkt))).xUnits(dc.units.ordinal).gap(10).elasticY(true).colors(colorBike2).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    barQyanSb.width(keys(lssbtype).length * 25 + marginJson.left + marginJson.right).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(sbDim).valueAccessor(function(it){
      return it.value.average;
    }).group(quanSb).x(d3.scale.ordinal().domain(keys(lssbtype))).xUnits(dc.units.ordinal).gap(15).elasticY(true).colors(colorBike2).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    barQuanTyp.width(barWidth).height(barHeight).margins(marginJson).renderlet(function(it){
      return it.selectAll("g.x text").attr({
        "dx": "10",
        "transform": "rotate(30)"
      });
    }).dimension(tyDim).group(quanTy).valueAccessor(function(it){
      return it.value.average;
    }).x(d3.scale.ordinal().domain(["na", "-10", "-5", "T", "+5"])).xUnits(dc.units.ordinal).gap(10).elasticY(true).colors(colorBike2).on("filtered", function(){
      return updateGraph();
    }).yAxis().ticks(3);
    updateGraph = function(){
      var all;
      clear();
      all = monthDim.top(Infinity);
      all.map(function(it){
        var c;
        if (lscolor[color(it.mktname)] === undefined) {
          lscolor[color(it.mktname)] = d3.rgb(color(it.mktname));
        }
        c = lscolor[color(it.mktname)];
        return drawPixel(~~scaleX(it.date), ~~scaleY(it[view]), c.r, c.g, c.b, 255);
      });
      d3.selectAll(".count").text('#' + numberWithCommas(all.length));
      return updateCanvas();
    };
    dc.renderAll();
    updateGraph();
    d3.selectAll(".title").text(drop(2, name) + lsenname[name]);
    function numberWithCommas(x){
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    setList = function(holderName, listData, onClick){
      var uls;
      uls = d3.selectAll(holderName).append("ul").attr("class", "dropdown-menu").attr("role", "menu");
      return uls.selectAll("li").data(listData).enter().append("li").append("a").style("cursor", "pointer").attr("data-target", "#").attr("class", "dropdown-action").text(function(it){
        return it;
      }).on("click", function(it){
        return onClick(it);
      });
    };
    return setList(".index-holder", lsveggie, function(it){
      return window.open('./index.html#' + it, '_blank');
    });
  });
});